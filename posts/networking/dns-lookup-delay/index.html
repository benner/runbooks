<!doctype html><html><head><script src=https://cmp.osano.com/16BZDoS1JlE62UZ1/f6bb69ca-7665-4605-8999-7add5bc8c2ac/osano.js></script><script type=application/javascript>var dnt=(navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack);var doNotTrack=(dnt=="1"||dnt=="yes");if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-53586058-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>DNS Lookup Delay &ndash; Runbooks</title><meta name=description property="og:description" content="Delay in DNS server response|"><meta name=apple-mobile-web-app-title content="Runbooks"><link rel=stylesheet href=/runbooks/assets/syntax.css><link rel=stylesheet href=/runbooks/assets/primer-build.css><link rel=stylesheet href=/runbooks/assets/style.css><meta name=google-site-verification content="QY77FEoaj64ru16unt_-52ygz5c4yOgssE3M81_8QDM"><link rel=stylesheet href=/runbooks/assets/custom_style.css></head><body class=bg-gray><div id=holy class="container-lg bg-white h-100"><div id=header class="px-1 bg-white"><nav class="UnderlineNav UnderlineNav--right px-2"><a class="UnderlineNav-actions muted-link h2" href=https://containersolutions.github.io/runbooks/>Runbooks</a><div class=UnderlineNav-body><div class="flex-column position-relative dropdown"><span class=UnderlineNav-item>Nav Menu</span><div class="Box Box--condensed position-absolute dropdown-content"><div class=Box-body><a href=/runbooks/>Home</a></div><div class=Box-body><a href=/runbooks/posts/kubernetes/>Kubernetes</a></div><div class=Box-body><a href=/runbooks/posts/linux/>Linux</a></div><div class=Box-body><a href=/runbooks/posts/networking/>Networking</a></div><div class=Box-body><a href=/runbooks/posts/python/>Python</a></div><div class=Box-body><a href=/runbooks/posts/how-to/>How-Tos</a></div></div></div></div></nav></div><div role=main id=main class="holy-main markdown-body px-4 bg-white"><div class=Subhead><div class=Subhead-heading><div class="h1 mt-3 mb-1">DNS Lookup Delay</div></div><div class=Subhead-description><div class=float-md-right><span title="Lastmod: 2020-06-25. Published at: 0001-01-01.">Lastmod: 2020-06-25</span></div></div></div><article><section class="pb-6 mb-3 border-bottom"><h2 id=overview>Overview</h2><p>This issue happens when your application pauses a significant period of time when doing a DNS lookup.</p><h2 id=check-runbook-match>Check RunBook Match</h2><p>If your application regularly pauses when doing anything on the network, but succesfully continues, this runbook may help.</p><h2 id=initial-steps-overview>Initial Steps Overview</h2><ol><li><p><a href=#step-1>Gather information</a></p></li><li><p><a href=#step-2>Run lookup on the command line</a></p></li><li><p><a href=#step-3>Subset of URLs?</a></p></li><li><p><a href=#step-4>Using DNSMasq?</a></p></li><li><p><a href=#step-5>IPTables?</a></p></li></ol><h2 id=detailed-steps>Detailed Steps</h2><h3 id=step-1>1) Gather information</h3><h4 id=step-1-1>1.1) Operating system</h4><p>First, determine which OS you are running. See the <a href=/runbooks/posts/how-to/determine-operating-system/>Determine Operating System How-To</a></p><h4 id=step1-2>1.2) DNS servers</h4><p>Next, determine which DNS servers you are using.</p><p>If your OS is <code>Darwin</code>/Mac/iOS, then run</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>scutil --dns &gt; /tmp/runbooks-dns-servers.txt
</code></pre></div><p>and capture the output.</p><p>If your OS is <code>Linux</code>, then run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cat /etc/resolv.conf | grep ^nameserver &gt; /tmp/runbooks-dns-servers.txt
</code></pre></div><h4 id=step1-3>1.3) Get host you are trying to look up</h4><p>You may need to get this from your application logs.</p><p>If you can&rsquo;t work this out, just use a &lsquo;standard&rsquo; one, like <code>google.com</code>.</p><p>This domain will be referred to as <code>[DOMAIN]</code> from here on.</p><h4 id=step1-4>1.4) Figure Out When This Started</h4><p>If this behaviour was not always happening on this host, then try and work out when it started.</p><h4 id=step1-5>1.5) How widespread is the problem</h4><p>If you can, determine whether this affects <em>all</em> DNS lookups or just a subset.</p><p>If it&rsquo;s just a subset, then you may want to skip to <a href=#step-3>Step 3</a></p><h4 id=step1-5>1.5) Are you running a DNS proxy?</h4><p>TODO: Background on DNS proxy</p><p>First try connecting to localhost on port 53 with telnet, eg if you run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>netstat -l | grep -w <span style=color:#ae81ff>53</span>
</code></pre></div><p>and get a response that contains a line like:</p><pre><code>udp        0      0 127.0.0.53:domain       0.0.0.0:*
</code></pre><p>then you have a server running on the DNS port on your local machine.</p><ul><li>Are you running DNSMasq? Running this may help determine that:</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ps -ef | grep -i dnsmasq
</code></pre></div><ul><li>Vagrant landrush?</li></ul><p>TODO</p><h3 id=step-2>2) Run lookup on the command line</h3><h3 id=step-2-1>2.1) Reproduce problem on the command line</h3><p>First, try and reproduce the problem by running a lookup on your machine</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>dig <span style=color:#f92672>[</span>DOMAIN<span style=color:#f92672>]</span>
</code></pre></div><p>If you can&rsquo;t reproduce the problem, then it may be that your application is using a different DNS lookup method than your host does.</p><h3 id=step-2-2>2.2) Run lookup against each nameserver in turn</h3><p>Then, do the same lookup on each nameserver you extracted from <a href=#step-1-2>step 1.2</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>dig @1.2.3.4 <span style=color:#f92672>[</span>DOMAIN<span style=color:#f92672>]</span>
</code></pre></div><p>If one of the nameservers is delayed, and the others are fast, consider moving to <a href=#solution-a>Solution A</a></p><h3 id=step-2-2>2.2) Run lookup against a well known DNS server</h3><p>Use a well-known public DNS server, for example Google&rsquo;s <code>8.8.8.8</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>dig @8.8.8.8 <span style=color:#f92672>[</span>DOMAIN<span style=color:#f92672>]</span>
</code></pre></div><p>to check whether the issue is with the nameservers you are using.</p><h3 id=step-3>3) Subset of URLs?</h3><p>If this issue affects a subset of URLs, then consider:</p><ul><li>do the affected domains return a large DNS response?</li></ul><p>If so, then you may be hitting limits on the size of the DNS response, which in turn trigger <a href=https://en.wikipedia.org/wiki/Maximum_transmission_unit>network MTUs</a> limits, or exceed the RFC length of DNS responses (see size limits <a href=https://tools.ietf.org/html/rfc1035>here</a>).</p><p>This has been seen when enterprises have</p><h3 id=step-4>4) Using DNSMasq?</h3><p>If you are using DNSMasq (a popular local DNS server), consider:</p><h4 id=step-4-1>4.1) DNSMasq config</h4><ul><li>whether DNSMasq could be causing the problem. Config to consider includes:</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>IGNORE_RESOLVCONF<span style=color:#f92672>=</span>yes
</code></pre></div><h4 id=step-4-2>4.2) <code>/etc/resolv.conf</code> DNSMasq Config</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
nameserver <span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>

restart dnsmasq
</code></pre></div><h4 id=step-4-3>4.3) Check DNSMasq logs</h4><p>This may give a clue as to where the issue lies.</p><p>TODO: more guidance here?</p><h4 id=step-4-4>4.4) Further information</h4><p>See below for more background that may help, and in <a href=#further-information>further information</a>:</p><p><a href=https://unix.stackexchange.com/posts/418180/revisions>Possible layers involved, along with systemd</a></p><h3 id=step-5>5) IPTables/NetFilter?</h3><p>It may be possible that IPTables/NetFilter is interfering with your DNS request somehow.</p><p>First, determine whether IPTables/NetFilter is</p><p>TODO: guidance here</p><h2 id=solutions-list>Solutions List</h2><p>A) <a href=#solution-a>Edit the nameserver list</a></p><h2 id=solution-detail>Solution Detail</h2><h3 id=solution-a>A) Edit the nameserver list</h3><p>If you are using Linux, then this is likely to be in <code>/etc/resolv.conf</code>.</p><p>If you are using Mac/iOS, then (?TODO?)</p><h2 id=check-resolution>Check Resolution</h2><p>Your application should no longer be pausing on DNS lookups.</p><h2 id=further-steps>Further Steps</h2><p>None</p><h2 id=further-information>Further Information</h2><p><a href=https://en.wikipedia.org/wiki/Maximum_transmission_unit>Network MTUs</a></p><p><a href=http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html>DNSMasq Documentation</a></p><p><a href=https://tools.ietf.org/html/rfc1035>RFC1035 - Domain Names - Implementation and Specification</a></p><p><a href=https://unix.stackexchange.com/posts/418180/revisions>DNSMasq layers</a></p><h2 id=owner>Owner</h2><p><a href=https://github.com/ianmiell>Ian Miell</a></p></section><section><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"runbooks"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></article></div><div id=side class="pr-1 bg-white"><aside class=pr-3><div id=toc class="Box Box--blue mb-3"><b>DNS Lookup Delay</b><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#check-runbook-match>Check RunBook Match</a></li><li><a href=#initial-steps-overview>Initial Steps Overview</a></li><li><a href=#detailed-steps>Detailed Steps</a><ul><li><a href=#step-1>1) Gather information</a></li><li><a href=#step-2>2) Run lookup on the command line</a></li><li><a href=#step-2-1>2.1) Reproduce problem on the command line</a></li><li><a href=#step-2-2>2.2) Run lookup against each nameserver in turn</a></li><li><a href=#step-2-2>2.2) Run lookup against a well known DNS server</a></li><li><a href=#step-3>3) Subset of URLs?</a></li><li><a href=#step-4>4) Using DNSMasq?</a></li><li><a href=#step-5>5) IPTables/NetFilter?</a></li></ul></li><li><a href=#solutions-list>Solutions List</a></li><li><a href=#solution-detail>Solution Detail</a><ul><li><a href=#solution-a>A) Edit the nameserver list</a></li></ul></li><li><a href=#check-resolution>Check Resolution</a></li><li><a href=#further-steps>Further Steps</a></li><li><a href=#further-information>Further Information</a></li><li><a href=#owner>Owner</a></li></ul></nav></div><div></div></aside></div><div id=footer class="pt-2 pb-3 bg-white text-center"></div></div><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><div class="container-lg bg-white h-50">&nbsp;</div><div class=footer-container-wrapper><div class=footer-image><a href=https://container-solutions.com><img src=https://containersolutions.github.io/runbooks/images/logo-main.svg class=hs-image-widget style=width:120px;border-width:0;border:0 width=120 alt=logo-main title=logo-main></a></div><div>Runbooks is sponsored by <a href=https://container-solutions.com>Container Solutions</a>. We bring culture, strategy, and technology together<br>&mdash;to make sure your Cloud Native migration is done right. <a href=https://www.container-solutions.com>See how we can help</a></div></div><div class="bg-white h-10"><div class="text-small text-gray credits">Powered by the
<a href=https://github.com/qqhann/hugo-primer class=link-gray-dark>Hugo-Primer</a> theme for
<a href=https://gohugo.io class=link-gray-dark>Hugo</a>.</div></div></body></html>